<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeneDIY-C V1.7: å¤šç‚¹çªå˜ä¸æ— ç¼å…‹éš†è®¡ç®—</title>
    <style>
        :root {
            --primary: #4f46e5;       /* Indigo */
            --primary-light: #e0e7ff;
            --danger: #e11d48;        /* Rose Red */
            --purple: #7c3aed;        /* Calculator Theme */
            --success: #16a34a;
            --surface: #ffffff;
            --bg: #f3f4f6;            /* Cool Gray */
            --text: #1f2937;
            --border: #d1d5db;
            --radius: 8px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            line-height: 1.5;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        header {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .brand { font-size: 1.4rem; font-weight: 800; color: var(--primary); display: flex; align-items: center; gap: 0.5rem; letter-spacing: -0.5px; }
        .meta { font-size: 0.875rem; color: #6b7280; font-family: monospace; }

        /* Main Layout */
        main {
            display: grid;
            grid-template-columns: 450px 1fr;
            gap: 1.5rem;
            padding: 1.5rem;
            height: calc(100vh - 70px);
            overflow: hidden;
        }

        /* Panels */
        .panel {
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 1.5rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
            border: 1px solid var(--border);
        }

        h2 { font-size: 1.1rem; font-weight: 700; margin-bottom: 0.5rem; color: var(--text); border-left: 4px solid var(--primary); padding-left: 0.75rem; }
        h3 { font-size: 1rem; font-weight: 600; color: var(--purple); display: flex; align-items: center; gap: 8px; margin: 0; }
        
        /* Inputs */
        .form-group { display: flex; flex-direction: column; gap: 0.5rem; position: relative; }
        label { font-size: 0.85rem; font-weight: 600; color: #374151; }
        input[type="text"], input[type="number"], select, textarea {
            padding: 0.6rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9rem;
            width: 100%;
            transition: border-color 0.2s;
        }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); ring: 2px var(--primary-light); }
        input.invalid { border-color: var(--danger); background-color: #fef2f2; }
        
        .row { display: flex; gap: 1rem; }
        .col { flex: 1; }

        /* Mode Switch */
        .mode-switch {
            display: flex;
            background: #e2e8f0;
            padding: 4px;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .mode-btn {
            flex: 1;
            text-align: center;
            padding: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            border-radius: 6px;
            color: #64748b;
            transition: all 0.2s;
        }
        .mode-btn.active {
            background: white;
            color: var(--primary);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        /* Auto Checkbox */
        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            color: var(--primary);
            background: var(--primary-light);
            padding: 8px;
            border-radius: 6px;
            margin-bottom: 10px;
        }
        input[type="checkbox"] { accent-color: var(--primary); cursor: pointer; }

        /* Slider */
        .slider-container { display: flex; align-items: center; gap: 1rem; }
        input[type="range"] { flex: 1; cursor: pointer; accent-color: var(--primary); }

        /* Multi-Site List */
        .mut-list { display: flex; flex-direction: column; gap: 8px; margin-top: 10px; }
        .mut-item { background: #f8fafc; border: 1px solid #e2e8f0; padding: 10px; border-radius: 6px; position: relative; }
        .mut-item-header { display: flex; justify-content: space-between; font-size: 0.85rem; font-weight: 600; color: #475569; margin-bottom: 4px; }
        .mut-item-desc { font-family: monospace; font-size: 0.8rem; color: var(--primary); }
        .btn-del-mut { color: var(--danger); cursor: pointer; font-size: 0.8rem; }
        .btn-add { background: #ecfdf5; color: var(--success); border: 1px dashed var(--success); text-align: center; padding: 8px; border-radius: 6px; cursor: pointer; font-size: 0.9rem; margin-top: 10px; }
        .btn-add:hover { background: #d1fae5; }

        /* Canvas Area */
        .canvas-container {
            position: relative;
            background: #f9fafb;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            height: 400px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
        }
        #plasmidCanvas { cursor: crosshair; }

        /* Results Cards */
        .result-card { background: #eff6ff; border: 1px solid #bfdbfe; border-radius: var(--radius); padding: 1rem; font-size: 0.9rem; margin-bottom: 12px; }
        .amplicon-header { font-weight: 700; color: var(--text); margin-bottom: 8px; padding-bottom: 4px; border-bottom: 1px solid #bfdbfe; display: flex; justify-content: space-between; }
        .primer-box { background: white; padding: 0.75rem; border-radius: 6px; margin-top: 0.5rem; border: 1px dashed var(--primary); position: relative; }
        .primer-seq { font-family: 'Courier New', monospace; word-break: break-all; line-height: 1.4; font-size: 0.95em; }
        .seq-label { font-size: 0.7rem; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px; display: block; }
        .part-overlap { color: #d97706; font-weight: bold; }
        .part-mut { color: var(--danger); font-weight: 900; background: #fee2e2; padding: 0 2px; border-radius: 2px; }
        .part-ext { color: var(--primary); font-weight: bold; }

        /* Buttons */
        .btn { background: var(--primary); color: white; border: none; padding: 0.75rem; border-radius: 6px; cursor: pointer; font-weight: 600; width: 100%; transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-top: 10px; }
        .btn:disabled { background: #9ca3af; cursor: not-allowed; transform: none; }
        .btn:hover:not(:disabled) { background: #4338ca; transform: translateY(-1px); }
        .btn-outline { background: white; border: 1px solid var(--primary); color: var(--primary); margin-top: 10px; }
        .btn-outline:hover { background: #e0e7ff; }
        .btn-calc { background: var(--purple); color: white; width: 100%; padding: 12px; font-size: 16px; margin-top: 15px; border: none; border-radius: 6px; cursor: pointer; transition: background 0.2s; }
        .btn-calc:hover { background: #6d28d9; }

        /* Calculator Styles */
        .calc-panel { border-top: 4px solid var(--purple); background: white; border-radius: 8px; padding: 15px; margin-top: 25px; box-shadow: var(--shadow); }
        .config-bar { background: #fdf4ff; padding: 12px; border-radius: 6px; margin: 15px 0; display: flex; gap: 15px; align-items: center; border: 1px solid #e9d5ff; flex-wrap: wrap; font-size: 0.9rem; }
        .mix-table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; font-size: 0.85rem; }
        .mix-table th { background: #f3f4f6; padding: 10px; text-align: left; border-bottom: 2px solid #e5e7eb; color: #374151; }
        .mix-table td { padding: 8px; border-bottom: 1px solid #f3f4f6; vertical-align: middle; }
        .mix-input { width: 100%; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px; text-align: center; font-family: 'Courier New'; }
        .mix-result { font-weight: bold; color: var(--purple); }
        .water-row { background: #fdf4ff; font-weight: bold; color: var(--purple); }

        /* Utilities */
        .hidden { display: none !important; }
        .error-msg { color: var(--danger); font-size: 0.75rem; margin-top: 4px; display: block; font-weight: 600; }
        .limit-hint { font-size: 0.75rem; color: #6b7280; margin-top: 2px; }
        
        /* Legend */
        .legend { display: flex; gap: 15px; font-size: 12px; margin-top: 10px; justify-content: center;}
        .legend-item { display: flex; align-items: center; gap: 4px; }
        .dot { width: 10px; height: 10px; border-radius: 2px; }

    </style>
</head>
<body>

<header>
    <div class="brand">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="M12 8v8"/></svg>
        GeneDIY-C
    </div>
    <div class="meta">
        Author: Jack Chang | Updated: 2026/01/16 (V1.7)
    </div>
</header>

<main>
    <div class="panel">
        <div>
            <h2>1. æ¨¡å¼é€‰æ‹©ä¸åºåˆ—</h2>
            <div class="mode-switch">
                <div class="mode-btn active" id="modeSingle" onclick="switchMode('single')">å•ç‚¹çªå˜ (Single Site)</div>
                <div class="mode-btn" id="modeMulti" onclick="switchMode('multi')">å¤šç‚¹çªå˜ (Multi-Site)</div>
            </div>
            
            <div class="form-group" style="margin-top:10px;">
                <label>è´¨ç²’åºåˆ— (5' -> 3') <span id="seqLength" style="float:right; color:#666; font-weight:400">0 bp</span></label>
                <textarea id="plasmidSeq" rows="4" placeholder="ç²˜è´´è´¨ç²’åºåˆ— (è‡ªåŠ¨è¿‡æ»¤éATCGå­—ç¬¦)..."></textarea>
            </div>
        </div>

        <div>
            <h2>2. å¼•ç‰©å‚æ•° (Partial Overlap)</h2>
            <div class="checkbox-wrapper">
                <input type="checkbox" id="autoTm" checked>
                <label for="autoTm" style="cursor:pointer; color:var(--primary)">è‡ªåŠ¨è°ƒæ•´å»¶ä¼¸åŒºé•¿åº¦ (Tm â‰ˆ 35Â°C)</label>
            </div>
            <div class="row">
                <div class="form-group col">
                    <label>Fwd å»¶ä¼¸åŒº (bp)</label>
                    <input type="number" id="fwdExtLen" value="15" min="10" max="20">
                </div>
                <div class="form-group col">
                    <label>Rev å»¶ä¼¸åŒº (bp)</label>
                    <input type="number" id="revExtLen" value="15" min="10" max="20">
                </div>
            </div>
             <div class="form-group" style="margin-top:10px">
                <label>é‡å åŒº Overlap (bp) <small style="color:#666">15-20bp</small></label>
                <input type="number" id="ovLen" value="15" min="15" max="30">
            </div>
        </div>

        <div id="singleConfig">
            <h2>3. çªå˜ä½ç‚¹è®¾ç½®</h2>
            <div class="form-group">
                <label>çªå˜èµ·å§‹ä½ç½® (Index)</label>
                <div class="slider-container">
                    <input type="range" id="posSlider" min="1" max="1" value="1">
                    <input type="number" id="posInput" min="1" value="1" style="width: 80px;">
                </div>
                <div id="contextSeq" style="font-family: monospace; text-align: center; margin-top: 8px; font-size: 13px; color: #4b5563; background:#f9fafb; padding:4px; border-radius:4px; border:1px solid #e5e7eb;"></div>
            </div>

            <div class="form-group">
                <label>çªå˜ç±»å‹</label>
                <select id="mutationType">
                    <option value="substitution">å•ç¢±åŸºæ›¿æ¢</option>
                    <option value="multi_substitution">å¤šç¢±åŸºæ›¿æ¢</option>
                    <option value="amino">æ°¨åŸºé…¸çªå˜</option>
                    <option value="insertion">æ’å…¥</option>
                    <option value="deletion">åˆ é™¤</option>
                </select>
            </div>

            <div id="baseSubInput" class="form-group input-area" style="margin-top:10px;">
                <label>æ–°ç¢±åŸº</label>
                <input type="text" id="targetBase" placeholder="å¦‚: T" maxlength="1">
            </div>
            <div id="multiSubInput" class="form-group input-area hidden" style="margin-top:10px;">
                <label>æ›¿æ¢åºåˆ— (Max 6bp)</label>
                <input type="text" id="multiSubSeq" placeholder="å¦‚: ATGC...">
                <small id="multiSubError" class="error-msg hidden">é”™è¯¯ï¼šé•¿åº¦è¶…è¿‡ 6bp</small>
            </div>
            <div id="aminoInput" class="form-group input-area hidden" style="margin-top:10px;">
                <label>ç›®æ ‡æ°¨åŸºé…¸</label>
                <div class="row">
                    <select id="targetAmino">
                        <option value="A">Alanine (A)</option>
                         <option value="R">Arginine (R)</option>
                        <option value="N">Asparagine (N)</option>
                        <option value="D">Aspartic Acid (D)</option>
                        <option value="C">Cysteine (C)</option>
                        <option value="Q">Glutamine (Q)</option>
                        <option value="E">Glutamic Acid (E)</option>
                        <option value="G">Glycine (G)</option>
                        <option value="H">Histidine (H)</option>
                        <option value="I">Isoleucine (I)</option>
                        <option value="L">Leucine (L)</option>
                        <option value="K">Lysine (K)</option>
                        <option value="M">Methionine (M)</option>
                        <option value="F">Phenylalanine (F)</option>
                        <option value="P">Proline (P)</option>
                        <option value="S">Serine (S)</option>
                        <option value="T">Threonine (T)</option>
                        <option value="W">Tryptophan (W)</option>
                        <option value="Y">Tyrosine (Y)</option>
                        <option value="V">Valine (V)</option>
                        <option value="*">STOP (*)</option>
                    </select>
                </div>
            </div>
            <div id="insInput" class="form-group input-area hidden" style="margin-top:10px;">
                <label>æ’å…¥åºåˆ— (Max 10bp)</label>
                <input type="text" id="insertSeq" placeholder="ATCG...">
                <small id="insError" class="error-msg hidden">é”™è¯¯ï¼šé•¿åº¦è¶…è¿‡ 10bp</small>
            </div>
            <div id="delInput" class="form-group input-area hidden" style="margin-top:10px;">
                <label>åˆ é™¤é•¿åº¦ (bp)</label>
                <input type="number" id="delLengthInput" value="3" min="1">
                <small id="delError" class="error-msg hidden">é”™è¯¯ï¼šè¶…é™</small>
            </div>
        </div>

        <div id="multiConfig" class="hidden">
            <h2>3. çªå˜åˆ—è¡¨ (ç‰‡æ®µæ‹¼æ¥)</h2>
            <div class="limit-hint" style="margin-bottom:5px">æç¤ºï¼šå…ˆåœ¨å•ç‚¹æ¨¡å¼é…ç½®å¥½å‚æ•°ï¼Œç‚¹å‡»ä¸‹æ–¹æ·»åŠ æŒ‰é’®åŠ å…¥åˆ—è¡¨ã€‚</div>
            <div id="mutListContainer" class="mut-list"></div>
            <div class="btn-add" onclick="addCurrentMutation()">+ æ·»åŠ å½“å‰é…ç½®çš„çªå˜</div>
        </div>
        
        <button class="btn" id="generateBtn">ç”Ÿæˆå¼•ç‰©ä¸å›¾è°±</button>
        <button class="btn btn-outline" id="exportBtn">å¯¼å‡º CSV æŠ¥å‘Š</button>
    </div>

    <div class="panel">
        <div class="canvas-container">
            <canvas id="plasmidCanvas" width="400" height="400"></canvas>
            
            <div style="position: absolute; bottom: 10px; width: 100%; text-align: center;">
                 <div class="legend">
                    <div class="legend-item"><div class="dot" style="background:var(--danger)"></div>Mutation</div>
                    <div class="legend-item"><div class="dot" style="background:var(--primary)"></div>Primer Ext</div>
                    <div class="legend-item"><div class="dot" style="background:#d97706"></div>Primer Overlap</div>
                </div>
            </div>
        </div>

        <div>
            <h2 style="display:flex; justify-content:space-between; align-items:center;">
                å¼•ç‰©è®¾è®¡ç»“æœ
            </h2>
            <div id="primerResults">
                <div style="text-align: center; color: #94a3b8; padding: 2rem; background: #f8fafc; border-radius: 8px; border: 1px dashed #cbd5e1;">
                    è¯·é…ç½®åºåˆ—å’Œå‚æ•°åç‚¹å‡»â€œç”Ÿæˆâ€
                </div>
            </div>
        </div>

        <div id="calculatorPanel" class="calc-panel hidden">
            <h3>ğŸ§ª æ— ç¼å…‹éš†ä½“ç³»è®¡ç®—å™¨</h3>
            <div class="config-bar">
                <div>è½½ä½“/éª¨æ¶è´¨é‡: <input type="number" id="calcVecMass" value="50" class="mix-input" style="width:60px; display:inline"> ng</div>
                <div>ç‰‡æ®µ:è½½ä½“ (æ‘©å°”æ¯”): <input type="number" id="calcRatio" value="2" class="mix-input" style="width:50px; display:inline"> : 1</div>
                <div>ä½“ç³»æ€»ä½“ç§¯: <input type="number" id="calcTotalVol" value="20" class="mix-input" style="width:50px; display:inline"> Î¼L</div>
            </div>

            <table class="mix-table">
                <thead>
                    <tr>
                        <th width="20%">ç»„åˆ†</th>
                        <th width="20%">é•¿åº¦ (bp)</th>
                        <th width="20%">æµ“åº¦ (ng/Î¼L)</th>
                        <th width="20%">ä½“ç§¯ (Î¼L)</th>
                        <th width="20%">æ‘©å°”æ•° (pmol)</th>
                    </tr>
                </thead>
                <tbody id="mixTableBody">
                    </tbody>
                <tfoot style="border-top: 2px solid #e5e7eb;">
                    <tr class="water-row">
                        <td colspan="3" style="text-align: right;">ğŸ’§ è¡¥æ°´ (ddHâ‚‚O) è‡³æ€»ä½“ç§¯:</td>
                        <td class="mix-result" id="resWater">-</td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
            
            <button class="btn-calc" onclick="calculateMix()">è®¡ç®—åŠ æ ·ä½“ç§¯</button>
            <p style="font-size: 11px; color: #64748b; margin-top: 10px; text-align: center;">
                * å…¬å¼: Mass(Frag) = Mass(Vec) Ã— [Len(Frag)/Len(Vec)] Ã— Ratio
            </p>
        </div>
    </div>
</main>

<script>
/** Data & Constants */
const NN_PARAMS = {'AA': [-7.9, -22.2], 'TT': [-7.9, -22.2], 'AT': [-7.2, -20.4], 'TA': [-7.2, -21.3], 'CA': [-8.5, -22.7], 'TG': [-8.5, -22.7], 'GT': [-8.4, -22.4], 'AC': [-8.4, -22.4], 'CT': [-7.8, -21.0], 'AG': [-7.8, -21.0], 'GA': [-8.2, -22.2], 'TC': [-8.2, -22.2], 'CG': [-10.6, -27.2], 'GC': [-9.8, -24.4], 'GG': [-8.0, -19.9], 'CC': [-8.0, -19.9], 'init': [0.2, -5.7], 'termGC': [0.1, -2.8], 'termAT': [2.3, 4.1]};
const OPTIMAL_CODONS = {'A': 'GCG', 'R': 'CGT', 'N': 'AAC', 'D': 'GAT', 'C': 'TGC', 'Q': 'CAG', 'E': 'GAA', 'G': 'GGC', 'H': 'CAT', 'I': 'ATT', 'L': 'CTG', 'K': 'AAA', 'M': 'ATG', 'F': 'TTC', 'P': 'CCG', 'S': 'AGC', 'T': 'ACC', 'W': 'TGG', 'Y': 'TAT', 'V': 'GTG', '*': 'TAA'};
const AA_MAP_REV = {'TTT':'F', 'TTC':'F', 'TTA':'L', 'TTG':'L', 'TCT':'S', 'TCC':'S', 'TCA':'S', 'TCG':'S', 'TAT':'Y', 'TAC':'Y', 'TAA':'*', 'TAG':'*', 'TGT':'C', 'TGC':'C', 'TGA':'*', 'TGG':'W', 'CTT':'L', 'CTC':'L', 'CTA':'L', 'CTG':'L', 'CCT':'P', 'CCC':'P', 'CCA':'P', 'CCG':'P', 'CAT':'H', 'CAC':'H', 'CAA':'Q', 'CAG':'Q', 'CGT':'R', 'CGC':'R', 'CGA':'R', 'CGG':'R', 'ATT':'I', 'ATC':'I', 'ATA':'I', 'ATG':'M', 'ACT':'T', 'ACC':'T', 'ACA':'T', 'ACG':'T', 'AAT':'N', 'AAC':'N', 'AAA':'K', 'AAG':'K', 'AGT':'S', 'AGC':'S', 'AGA':'R', 'AGG':'R', 'GTT':'V', 'GTC':'V', 'GTA':'V', 'GTG':'V', 'GCT':'A', 'GCC':'A', 'GCA':'A', 'GCG':'A', 'GAT':'D', 'GAC':'D', 'GAA':'E', 'GAG':'E', 'GGT':'G', 'GGC':'G', 'GGA':'G', 'GGG':'G'};

/* State */
let appMode = 'single';
let mutList = []; 
let appData = { seq: "", primers: null };

/* DOM Elements */
const els = {
    plasmidSeq: document.getElementById('plasmidSeq'),
    seqLength: document.getElementById('seqLength'),
    modeSingle: document.getElementById('modeSingle'),
    modeMulti: document.getElementById('modeMulti'),
    singleConfig: document.getElementById('singleConfig'),
    multiConfig: document.getElementById('multiConfig'),
    mutListContainer: document.getElementById('mutListContainer'),
    calculatorPanel: document.getElementById('calculatorPanel'),
    mixTableBody: document.getElementById('mixTableBody'),
    // Inputs
    posSlider: document.getElementById('posSlider'),
    posInput: document.getElementById('posInput'),
    mutType: document.getElementById('mutationType'),
    targetBase: document.getElementById('targetBase'),
    multiSubSeq: document.getElementById('multiSubSeq'),
    insertSeq: document.getElementById('insertSeq'),
    delLengthInput: document.getElementById('delLengthInput'),
    targetAmino: document.getElementById('targetAmino'),
    // Params
    fwdExtLen: document.getElementById('fwdExtLen'),
    revExtLen: document.getElementById('revExtLen'),
    ovLen: document.getElementById('ovLen'),
    autoTm: document.getElementById('autoTm'),
    // Output
    generateBtn: document.getElementById('generateBtn'),
    exportBtn: document.getElementById('exportBtn'),
    results: document.getElementById('primerResults'),
    canvas: document.getElementById('plasmidCanvas')
};

/* --- Utils --- */
function revComp(seq) {
    const map = {'A':'T', 'T':'A', 'C':'G', 'G':'C', 'N':'N'};
    return seq.toUpperCase().split('').reverse().map(b => map[b] || b).join('');
}
function getCircularSeq(fullSeq, start, length) {
    const len = fullSeq.length;
    let s = (start % len + len) % len;
    let result = "";
    for (let i = 0; i < length; i++) {
        result += fullSeq[(s + i) % len];
    }
    return result;
}
function calculateTm(seq) {
    seq = seq.toUpperCase();
    if (seq.length < 8) return 0;
    let dH = NN_PARAMS.init[0], dS = NN_PARAMS.init[1];
    if (/[AT]/.test(seq[0])) { dH += NN_PARAMS.termAT[0]; dS += NN_PARAMS.termAT[1]; } else { dH += NN_PARAMS.termGC[0]; dS += NN_PARAMS.termGC[1]; }
    if (/[AT]/.test(seq[seq.length-1])) { dH += NN_PARAMS.termAT[0]; dS += NN_PARAMS.termAT[1]; } else { dH += NN_PARAMS.termGC[0]; dS += NN_PARAMS.termGC[1]; }
    for (let i = 0; i < seq.length - 1; i++) {
        let n = seq.substring(i, i+2);
        if (NN_PARAMS[n]) { dH += NN_PARAMS[n][0]; dS += NN_PARAMS[n][1]; }
    }
    const Na_eq = 50e-3 + 3.3 * Math.sqrt(2.0e-3);
    return parseFloat(((dH * 1000) / (dS + 1.987 * Math.log(250e-9/4)) - 273.15 + 16.6 * Math.log10(Na_eq)).toFixed(1));
}

/* --- Logic & Events --- */
function switchMode(mode) {
    appMode = mode;
    els.calculatorPanel.classList.add('hidden'); // Hide calc on mode switch
    if(mode === 'single') {
        els.modeSingle.classList.add('active');
        els.modeMulti.classList.remove('active');
        els.singleConfig.classList.remove('hidden');
        els.multiConfig.classList.add('hidden');
    } else {
        els.modeMulti.classList.add('active');
        els.modeSingle.classList.remove('active');
        els.singleConfig.classList.remove('hidden');
        els.multiConfig.classList.remove('hidden');
    }
    validateAll();
}

els.plasmidSeq.addEventListener('input', (e) => {
    e.target.value = e.target.value.replace(/[^ATCGatcg]/g, '').toUpperCase();
    els.seqLength.textContent = e.target.value.length + " bp";
    els.posSlider.max = e.target.value.length || 1;
    validateAll();
    updateContext();
});

[els.posSlider, els.posInput].forEach(el => el.addEventListener('input', (e) => {
    if(e.target === els.posSlider) els.posInput.value = els.posSlider.value;
    else els.posSlider.value = els.posInput.value;
    updateContext();
}));

els.mutType.addEventListener('change', () => {
    const type = els.mutType.value;
    document.querySelectorAll('.input-area').forEach(el => el.classList.add('hidden'));
    if (type === 'substitution') document.getElementById('baseSubInput').classList.remove('hidden');
    else if (type === 'multi_substitution') document.getElementById('multiSubInput').classList.remove('hidden');
    else if (type === 'amino') document.getElementById('aminoInput').classList.remove('hidden');
    else if (type === 'insertion') document.getElementById('insInput').classList.remove('hidden');
    else if (type === 'deletion') document.getElementById('delInput').classList.remove('hidden');
    validateAll();
    updateContext();
});

function validateAll() {
    let isValid = true;
    const type = els.mutType.value;
    const seqLen = els.plasmidSeq.value.length;
    document.querySelectorAll('.error-msg').forEach(el => el.classList.add('hidden'));
    document.querySelectorAll('input').forEach(el => el.classList.remove('invalid'));

    if(type === 'multi_substitution') {
        let v = els.multiSubSeq.value.replace(/[^ATCGatcg]/g, '').toUpperCase();
        els.multiSubSeq.value = v;
        if(v.length > 6) { document.getElementById('multiSubError').classList.remove('hidden'); els.multiSubSeq.classList.add('invalid'); isValid=false; }
    } else if (type === 'insertion') {
        let v = els.insertSeq.value.replace(/[^ATCGatcg]/g, '').toUpperCase();
        els.insertSeq.value = v;
        if(v.length > 10) { document.getElementById('insError').classList.remove('hidden'); els.insertSeq.classList.add('invalid'); isValid=false; }
    } else if (type === 'deletion') {
        let v = parseInt(els.delLengthInput.value);
        if(seqLen > 0 && v > seqLen * 0.7) { document.getElementById('delError').classList.remove('hidden'); els.delLengthInput.classList.add('invalid'); isValid=false; }
    }
    els.generateBtn.disabled = !isValid;
}

['input', 'change'].forEach(evt => {
    els.multiSubSeq.addEventListener(evt, validateAll);
    els.insertSeq.addEventListener(evt, validateAll);
    els.delLengthInput.addEventListener(evt, validateAll);
});

function updateContext() {
    const seq = els.plasmidSeq.value;
    if (!seq) return;
    const idx = parseInt(els.posInput.value) - 1;
    const before = getCircularSeq(seq, idx - 5, 5).toLowerCase();
    const target = getCircularSeq(seq, idx, 1);
    const after = getCircularSeq(seq, idx + 1, 5).toLowerCase();
    let html = `${before} <span style="color:var(--danger); font-weight:bold; border-bottom:2px solid var(--danger)">${target}</span> ${after}`;
    if (els.mutType.value === 'amino') {
        const codon = getCircularSeq(seq, idx, 3);
        const aa = AA_MAP_REV[codon] || '?';
        html += `<br><span style="color:var(--primary); font-size:11px;">Codon: ${codon} (${aa})</span>`;
    }
    document.getElementById('contextSeq').innerHTML = html;
}

/* --- Multi-Site Logic --- */
function addCurrentMutation() {
    const seq = els.plasmidSeq.value;
    if(!seq) return alert("è¯·å…ˆè¾“å…¥è½½ä½“åºåˆ—");
    const pos = parseInt(els.posInput.value) - 1;
    const type = els.mutType.value;
    let mutObj = { pos: pos, type: type, seq: "", delLen: 0, desc: "" };

    if (type === 'substitution') {
        mutObj.seq = els.targetBase.value.toUpperCase() || 'N';
        mutObj.delLen = 1;
        mutObj.desc = `${getCircularSeq(seq, pos, 1)}${pos+1}${mutObj.seq}`;
    } else if (type === 'multi_substitution') {
        mutObj.seq = els.multiSubSeq.value.toUpperCase();
        mutObj.delLen = mutObj.seq.length;
        mutObj.desc = `Sub(${mutObj.delLen}bp) @ ${pos+1}`;
    } else if (type === 'amino') {
        mutObj.seq = OPTIMAL_CODONS[els.targetAmino.value];
        mutObj.delLen = 3;
        mutObj.desc = `${AA_MAP_REV[getCircularSeq(seq, pos, 3)]}${Math.floor(pos/3)+1}${els.targetAmino.value}`;
    } else if (type === 'insertion') {
        mutObj.seq = els.insertSeq.value.toUpperCase();
        mutObj.delLen = 0;
        mutObj.desc = `Ins(${mutObj.seq.length}bp) @ ${pos+1}`;
    } else if (type === 'deletion') {
        mutObj.seq = "";
        mutObj.delLen = parseInt(els.delLengthInput.value);
        mutObj.desc = `Del(${mutObj.delLen}bp) @ ${pos+1}`;
    }

    if(mutList.some(m => m.pos === pos)) { alert("è¯¥ä½ç½®å·²å­˜åœ¨çªå˜ï¼"); return; }
    mutList.push(mutObj);
    mutList.sort((a,b) => a.pos - b.pos);
    renderMutList();
}

function renderMutList() {
    const container = els.mutListContainer;
    container.innerHTML = "";
    mutList.forEach((m, idx) => {
        const div = document.createElement('div');
        div.className = 'mut-item';
        div.innerHTML = `
            <div class="mut-item-header"><span>Mutation ${idx+1}</span><span class="btn-del-mut" onclick="removeMut(${idx})">ğŸ—‘ åˆ é™¤</span></div>
            <div class="mut-item-desc">${m.desc} (Pos: ${m.pos+1})</div>`;
        container.appendChild(div);
    });
}
window.removeMut = function(idx) { mutList.splice(idx, 1); renderMutList(); }

/* --- Generation Logic --- */
function optimizeExtensionLength(fullSeq, startIdx, isRev) {
    let bestLen = 15;
    let minDiff = 999;
    for (let len = 10; len <= 20; len++) {
        let seqFrag = isRev ? revComp(getCircularSeq(fullSeq, startIdx - len, len)) : getCircularSeq(fullSeq, startIdx, len);
        let diff = Math.abs(calculateTm(seqFrag) - 35.0);
        if (diff < minDiff) { minDiff = diff; bestLen = len; }
    }
    return bestLen;
}

els.generateBtn.addEventListener('click', () => {
    const seq = els.plasmidSeq.value;
    if(!seq) return alert("æ— åºåˆ—");

    if (appMode === 'single') {
        const pos = parseInt(els.posInput.value) - 1;
        const type = els.mutType.value;
        let mutObj = { pos, type, seq: "", delLen: 0, desc: "" };
        if(type==='substitution') { mutObj.seq = els.targetBase.value.toUpperCase(); mutObj.delLen=1; mutObj.desc="Single Sub"; }
        else if(type==='multi_substitution') { mutObj.seq = els.multiSubSeq.value; mutObj.delLen=mutObj.seq.length; mutObj.desc="Multi Sub"; }
        else if(type==='amino') { mutObj.seq = OPTIMAL_CODONS[els.targetAmino.value]; mutObj.delLen=3; mutObj.desc="Amino"; }
        else if(type==='insertion') { mutObj.seq = els.insertSeq.value; mutObj.delLen=0; mutObj.desc="Ins"; }
        else if(type==='deletion') { mutObj.seq=""; mutObj.delLen=parseInt(els.delLengthInput.value); mutObj.desc="Del"; }
        
        appData.primers = designFragments([mutObj], seq);
        els.calculatorPanel.classList.add('hidden'); // No calc for single
    } else {
        if(mutList.length === 0) return alert("è¯·æ·»åŠ è‡³å°‘ä¸€ä¸ªçªå˜ä½ç‚¹");
        appData.primers = designFragments(mutList, seq);
        // INIT CALCULATOR for Multi Mode
        initCalculator(appData.primers);
        els.calculatorPanel.classList.remove('hidden');
    }
    renderResults();
    drawPlasmid();
});

function designFragments(mutations, seq) {
    const fragments = [];
    const ovLen = parseInt(els.ovLen.value);
    const isAuto = els.autoTm.checked;
    
    for(let i=0; i<mutations.length; i++) {
        const curr = mutations[i];
        const next = mutations[(i+1) % mutations.length];
        
        let fwdStart = curr.pos + curr.delLen;
        let fwdExtLen = isAuto ? optimizeExtensionLength(seq, fwdStart, false) : parseInt(els.fwdExtLen.value);
        const fwdOverlap = getCircularSeq(seq, curr.pos - ovLen, ovLen);
        const fwdMut = curr.seq;
        const fwdExt = getCircularSeq(seq, fwdStart, fwdExtLen);
        const fwdFull = fwdOverlap + fwdMut.toLowerCase() + fwdExt;
        
        let revRef = next.pos - ovLen;
        let revExtLen = isAuto ? optimizeExtensionLength(seq, revRef, true) : parseInt(els.revExtLen.value);
        const nextFwdOverlap = getCircularSeq(seq, next.pos - ovLen, ovLen);
        const revOverlap = revComp(nextFwdOverlap);
        const revMut = revComp(next.seq);
        const revExtRaw = getCircularSeq(seq, next.pos - ovLen - revExtLen, revExtLen);
        const revExt = revComp(revExtRaw);
        const revFull = revOverlap + revMut.toLowerCase() + revExt;

        let startIdx = curr.pos + curr.delLen;
        let endIdx = next.pos - ovLen;
        let ampLen = (endIdx - startIdx + seq.length) % seq.length;
        
        // Approximate PCR product length (Amplicon + Primer contributions)
        // Note: For seamless, we often care about the full length including overhangs
        let pcrLen = ampLen + fwdFull.length + revFull.length; // Approximate upper bound, good enough for mass
        
        fragments.push({
            id: i+1,
            startInfo: curr, endInfo: next,
            fwd: { seq: fwdFull, ov: fwdOverlap, mut: fwdMut, ext: fwdExt, tm: calculateTm(fwdExt) },
            rev: { seq: revFull, ov: revOverlap, mut: revMut, ext: revExt, tm: calculateTm(revExt) },
            ampLen: ampLen,
            pcrLen: pcrLen
        });
    }
    return fragments;
}

function renderResults() {
    const frags = appData.primers;
    els.results.innerHTML = "";
    frags.forEach(f => {
        const div = document.createElement('div');
        div.className = 'result-card';
        div.innerHTML = `
            <div class="amplicon-header">
                <span>Amplicon ${f.id} (Fragment)</span>
                <span style="font-weight:400; font-size:0.8em">Length: ~${f.pcrLen} bp</span>
            </div>
            <div style="font-size:0.8em; color:#666; margin-bottom:4px">
                Covers: Mut ${f.startInfo.desc} âœ Mut ${f.endInfo.desc}
            </div>
            <div class="primer-box">
                <span class="seq-label">Forward Primer (Start) - Tm(Ext): ${f.fwd.tm}Â°C</span>
                <div class="primer-seq"><span class="part-overlap">${f.fwd.ov}</span><span class="part-mut">${f.fwd.mut.toLowerCase()}</span><span class="part-ext">${f.fwd.ext}</span></div>
            </div>
            <div class="primer-box">
                <span class="seq-label">Reverse Primer (End) - Tm(Ext): ${f.rev.tm}Â°C</span>
                <div class="primer-seq"><span class="part-overlap">${f.rev.ov}</span><span class="part-mut">${f.rev.mut.toLowerCase()}</span><span class="part-ext">${f.rev.ext}</span></div>
            </div>`;
        els.results.appendChild(div);
    });
}

/* --- Calculator Logic --- */
function initCalculator(fragments) {
    const tbody = els.mixTableBody;
    tbody.innerHTML = ""; // Clear existing

    // 1. Vector Row (Optional usage)
    const vecRow = `
        <tr style="background:#f9fafb">
            <td><b>çº¿æ€§åŒ–è½½ä½“ (å¯é€‰)</b></td>
            <td><input type="number" id="mixVecLen" class="mix-input" placeholder="bp"></td>
            <td><input type="number" id="mixVecConc" class="mix-input" placeholder="ng/Î¼L"></td>
            <td class="mix-result" id="resVecVol">-</td>
            <td style="font-size:11px; color:#666" id="resVecPmol">-</td>
        </tr>`;
    tbody.innerHTML += vecRow;

    // 2. Fragment Rows
    fragments.forEach((f, idx) => {
        const row = `
            <tr>
                <td>ç‰‡æ®µ ${f.id} (Amplicon)</td>
                <td><input type="number" id="mixFragLen${idx}" class="mix-input" value="${f.pcrLen}"></td>
                <td><input type="number" id="mixFragConc${idx}" class="mix-input" placeholder="ng/Î¼L"></td>
                <td class="mix-result" id="resFragVol${idx}">-</td>
                <td style="font-size:11px; color:#666" id="resFragPmol${idx}">-</td>
            </tr>`;
        tbody.innerHTML += row;
    });
}

window.calculateMix = function() {
    const vecMass = parseFloat(document.getElementById('calcVecMass').value) || 0;
    const ratio = parseFloat(document.getElementById('calcRatio').value) || 0;
    const totalVol = parseFloat(document.getElementById('calcTotalVol').value) || 20;

    // Vector Calculation (If user inputs data, otherwise treat as 0 for Pure Fragment assembly)
    const vecLenInput = document.getElementById('mixVecLen');
    const vecConcInput = document.getElementById('mixVecConc');
    let vecVol = 0; 
    let basePmol = 0; // The reference pmol

    if (vecLenInput.value && vecConcInput.value) {
        const vLen = parseFloat(vecLenInput.value);
        const vConc = parseFloat(vecConcInput.value);
        basePmol = (vecMass * 1000) / (vLen * 660);
        vecVol = vecMass / vConc;
        document.getElementById('resVecPmol').innerText = basePmol.toFixed(3);
        document.getElementById('resVecVol').innerText = vecVol.toFixed(2);
    } else {
        document.getElementById('resVecVol').innerText = "(Skip)";
        // If skipping vector, assume user wants to base pmol on Mass of first fragment? 
        // Or simply fail? Usually Seamless requires a Vector backbone row.
        // Let's assume if vector is empty, use the mass on the first fragment as reference?
        // Simpler: Alert user or allow pure fragment assembly logic (requires define logic).
        // Defaulting to: If Vector empty, Vector Vol = 0.
        // But we need a base pmol. If no vector, calculate base pmol from Mass input applied to Frag 1?
        // For simplicity: We enforce Vector Row usage OR user puts the "Backbone Fragment" in the vector row manually.
    }

    let currentTotalVol = vecVol;

    // Fragment Calculations
    const frags = appData.primers || [];
    frags.forEach((f, idx) => {
        const lenEl = document.getElementById(`mixFragLen${idx}`);
        const concEl = document.getElementById(`mixFragConc${idx}`);
        const resVolEl = document.getElementById(`resFragVol${idx}`);
        const resPmolEl = document.getElementById(`resFragPmol${idx}`);

        if(lenEl && concEl && lenEl.value && concEl.value) {
            const fLen = parseFloat(lenEl.value);
            const fConc = parseFloat(concEl.value);
            
            // If basePmol is 0 (no vector info), try to establish it from Frag 1 being the "Vector" equivalent?
            // Standard behavior: Use Vector as base.
            
            if (basePmol > 0) {
                const targetPmol = basePmol * ratio;
                const reqMass = (targetPmol * fLen * 660) / 1000;
                const reqVol = reqMass / fConc;
                
                resPmolEl.innerText = targetPmol.toFixed(3);
                resVolEl.innerText = reqVol.toFixed(2);
                currentTotalVol += reqVol;
            } else {
                resVolEl.innerText = "?";
            }
        } else {
            resVolEl.innerText = "-";
        }
    });

    // Water
    const waterVol = totalVol - currentTotalVol;
    const waterEl = document.getElementById('resWater');
    if (waterVol < 0) {
        waterEl.innerText = "ä½“ç§¯è¶…æ ‡!";
        waterEl.style.color = "red";
    } else {
        waterEl.innerText = waterVol.toFixed(2);
        waterEl.style.color = "var(--purple)";
    }
}

function drawPlasmid() {
    const ctx = els.canvas.getContext('2d');
    const w = els.canvas.width, h = els.canvas.height;
    const cx = w/2, cy = h/2, r = 130;
    ctx.clearRect(0,0,w,h);
    
    ctx.beginPath();
    ctx.arc(cx, cy, r, 0, 2*Math.PI);
    ctx.strokeStyle = '#e2e8f0'; ctx.lineWidth = 20; ctx.stroke();

    ctx.fillStyle = '#64748b'; ctx.font = 'bold 16px sans-serif'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
    ctx.fillText("GeneDIY-C", cx, cy-10); ctx.font = '12px monospace'; ctx.fillText(`${els.plasmidSeq.value.length} bp`, cx, cy+10);

    const frags = appData.primers;
    if(!frags) return;
    const totalLen = els.plasmidSeq.value.length;
    const colors = ['#4f46e5', '#0ea5e9', '#8b5cf6', '#ec4899']; 

    frags.forEach((f, idx) => {
        let startRad = -0.5*Math.PI + (f.startInfo.pos / totalLen) * 2*Math.PI;
        let endRad = -0.5*Math.PI + (f.endInfo.pos / totalLen) * 2*Math.PI;
        if (endRad <= startRad) endRad += 2*Math.PI; 
        const color = colors[idx % colors.length];
        
        ctx.beginPath();
        ctx.arc(cx, cy, r + 15 + (idx*5), startRad, endRad);
        ctx.strokeStyle = color; ctx.lineWidth = 4; ctx.stroke();
        drawArrow(ctx, cx, cy, r + 15 + (idx*5), startRad, startRad + 0.1, color, true);
        drawArrow(ctx, cx, cy, r + 15 + (idx*5), endRad, endRad - 0.1, color, false);
        drawMutMark(ctx, cx, cy, r, startRad);
    });
}
function drawArrow(ctx, cx, cy, r, startAngle, endAngle, color, cw) {
    const tipX = cx + r * Math.cos(endAngle); const tipY = cy + r * Math.sin(endAngle);
    ctx.save(); ctx.translate(tipX, tipY); ctx.rotate(endAngle + (cw ? Math.PI/2 : -Math.PI/2));
    ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(-4,8); ctx.lineTo(4,8); ctx.fillStyle = color; ctx.fill(); ctx.restore();
}
function drawMutMark(ctx, cx, cy, r, angle) {
    const x = cx + r * Math.cos(angle); const y = cy + r * Math.sin(angle);
    ctx.save(); ctx.translate(x, y); ctx.rotate(angle); ctx.fillStyle = '#e11d48'; ctx.font = 'bold 14px sans-serif'; ctx.fillText('X', 0, 0); ctx.restore();
}

els.exportBtn.addEventListener('click', () => {
    if (!appData.primers) return;
    let csv = `GeneDIY-C Report (V1.7)\nMode,${appMode}\nVector Length,${els.plasmidSeq.value.length}\n\n`;
    appData.primers.forEach(f => {
        csv += `Fragment ${f.id} (Mut ${f.startInfo.desc} to Mut ${f.endInfo.desc})\n`;
        csv += `Type,Name,Sequence (5'-3'),Length,Tm(Ext)\n`;
        csv += `Forward,Frag${f.id}_F,${f.fwd.seq},${f.fwd.seq.length},${f.fwd.tm}\n`;
        csv += `Reverse,Frag${f.id}_R,${f.rev.seq},${f.rev.seq.length},${f.rev.tm}\n\n`;
    });
    const blob = new Blob(["\uFEFF"+csv], {type: 'text/csv;charset=utf-8;'});
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "GeneDIY-C_Primers.csv";
    link.click();
});
</script>
</body>
</html>