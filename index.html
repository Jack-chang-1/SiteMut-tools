<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeneDIY-C: 定点突变引物设计工具</title>
    <style>
        :root {
            --primary: #4f46e5;       /* Indigo */
            --primary-light: #e0e7ff;
            --danger: #e11d48;        /* Rose Red */
            --warning: #d97706;       /* Amber */
            --success: #16a34a;
            --surface: #ffffff;
            --bg: #f3f4f6;            /* Cool Gray */
            --text: #1f2937;
            --border: #d1d5db;
            --radius: 8px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            line-height: 1.5;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header */
        header {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }
        .brand { font-size: 1.4rem; font-weight: 800; color: var(--primary); display: flex; align-items: center; gap: 0.5rem; letter-spacing: -0.5px; }
        .meta { font-size: 0.875rem; color: #6b7280; font-family: monospace; }

        /* Main Layout */
        main {
            display: grid;
            grid-template-columns: 420px 1fr;
            gap: 1.5rem;
            padding: 1.5rem;
            height: calc(100vh - 70px);
            overflow: hidden;
        }

        /* Panels */
        .panel {
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 1.5rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
            border: 1px solid var(--border);
        }

        h2 { font-size: 1.1rem; font-weight: 700; margin-bottom: 0.5rem; color: var(--text); border-left: 4px solid var(--primary); padding-left: 0.75rem; }
        
        /* Inputs */
        .form-group { display: flex; flex-direction: column; gap: 0.5rem; position: relative; }
        label { font-size: 0.85rem; font-weight: 600; color: #374151; }
        input[type="text"], input[type="number"], select, textarea {
            padding: 0.6rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.9rem;
            width: 100%;
            transition: border-color 0.2s;
        }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); ring: 2px var(--primary-light); }
        input.invalid { border-color: var(--danger); background-color: #fef2f2; }
        
        .row { display: flex; gap: 1rem; }
        .col { flex: 1; }

        /* Auto Checkbox */
        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            color: var(--primary);
            background: var(--primary-light);
            padding: 8px;
            border-radius: 6px;
            margin-bottom: 10px;
        }
        input[type="checkbox"] { accent-color: var(--primary); cursor: pointer; }

        /* Slider */
        .slider-container { display: flex; align-items: center; gap: 1rem; }
        input[type="range"] { flex: 1; cursor: pointer; accent-color: var(--primary); }

        /* Canvas Area */
        .canvas-container {
            position: relative;
            background: #f9fafb;
            border-radius: var(--radius);
            border: 1px solid var(--border);
            height: 480px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #plasmidCanvas { cursor: crosshair; }
        .canvas-tooltip {
            position: absolute;
            background: rgba(0,0,0,0.85);
            color: white;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            display: none;
            z-index: 10;
            white-space: pre-wrap;
        }

        /* Results Cards */
        .result-card {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: var(--radius);
            padding: 1rem;
            font-size: 0.9rem;
        }
        .primer-box {
            background: white;
            padding: 0.75rem;
            border-radius: 6px;
            margin-top: 0.5rem;
            border: 1px dashed var(--primary);
            position: relative;
        }
        .primer-seq {
            font-family: 'Courier New', monospace;
            word-break: break-all;
            line-height: 1.4;
            font-size: 0.95em;
        }
        .seq-label {
            font-size: 0.7rem;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 2px;
            display: block;
        }
        .part-overlap { color: #d97706; font-weight: bold; }
        .part-mut { color: var(--danger); font-weight: 900; background: #fee2e2; padding: 0 2px; border-radius: 2px; }
        .part-ext { color: var(--primary); font-weight: bold; }

        /* Buttons */
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            width: 100%;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn:disabled { background: #9ca3af; cursor: not-allowed; transform: none; }
        .btn:hover:not(:disabled) { background: #4338ca; transform: translateY(-1px); }
        .btn-outline { background: white; border: 1px solid var(--primary); color: var(--primary); margin-top: 10px; }
        .btn-outline:hover { background: #e0e7ff; }

        /* Utilities */
        .hidden { display: none !important; }
        .error-msg { color: var(--danger); font-size: 0.75rem; margin-top: 4px; display: block; font-weight: 600; }
        .limit-hint { font-size: 0.75rem; color: #6b7280; margin-top: 2px; }
        
        /* Legend */
        .legend { display: flex; gap: 15px; font-size: 12px; margin-top: 10px; justify-content: center;}
        .legend-item { display: flex; align-items: center; gap: 4px; }
        .dot { width: 10px; height: 10px; border-radius: 2px; }

    </style>
</head>
<body>

<header>
    <div class="brand">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="M12 8v8"/></svg>
        GeneDIY-C
    </div>
    <div class="meta">
        Author: Jack Chang | Updated: 2026/01/16
    </div>
</header>

<main>
    <div class="panel">
        <div>
            <h2>1. 载体序列输入</h2>
            <div class="form-group">
                <label>质粒序列 (5' -> 3') <span id="seqLength" style="float:right; color:#666; font-weight:400">0 bp</span></label>
                <textarea id="plasmidSeq" rows="4" placeholder="粘贴质粒序列 (自动过滤非ATCG字符)..."></textarea>
            </div>
        </div>

        <div>
            <h2>2. 引物参数 (Partial Overlap)</h2>
            <div class="checkbox-wrapper">
                <input type="checkbox" id="autoTm" checked>
                <label for="autoTm" style="cursor:pointer; color:var(--primary)">自动调整延伸区长度 (Tm ≈ 35°C)</label>
            </div>
            <div class="row">
                <div class="form-group col">
                    <label>Fwd 延伸区 (bp)</label>
                    <input type="number" id="fwdExtLen" value="15" min="10" max="20">
                </div>
                <div class="form-group col">
                    <label>Rev 延伸区 (bp)</label>
                    <input type="number" id="revExtLen" value="15" min="10" max="20">
                </div>
            </div>
             <div class="form-group" style="margin-top:10px">
                <label>重叠区 Overlap (bp) <small style="color:#666">15-20bp</small></label>
                <input type="number" id="ovLen" value="15" min="15" max="30">
            </div>
        </div>

        <div>
            <h2>3. 突变位点与类型</h2>
            <div class="form-group">
                <label>突变起始位置 (Index: 1-based)</label>
                <div class="slider-container">
                    <input type="range" id="posSlider" min="1" max="1" value="1">
                    <input type="number" id="posInput" min="1" value="1" style="width: 80px;">
                </div>
                <div id="contextSeq" style="font-family: monospace; text-align: center; margin-top: 8px; font-size: 13px; color: #4b5563; background:#f9fafb; padding:4px; border-radius:4px; border:1px solid #e5e7eb;">
                    </div>
            </div>

            <div class="form-group">
                <label>突变类型</label>
                <select id="mutationType">
                    <option value="substitution">单碱基替换 (Single Base Substitution)</option>
                    <option value="multi_substitution">多碱基替换 (Multi-base Substitution)</option>
                    <option value="amino">氨基酸突变 (Amino Acid Change)</option>
                    <option value="insertion">插入 (Insertion)</option>
                    <option value="deletion">删除 (Deletion)</option>
                </select>
            </div>

            <div id="baseSubInput" class="form-group input-area" style="margin-top:10px;">
                <label>新碱基</label>
                <input type="text" id="targetBase" placeholder="如: T" maxlength="1">
            </div>

            <div id="multiSubInput" class="form-group input-area hidden" style="margin-top:10px;">
                <label>新碱基序列 (替换原序列)</label>
                <input type="text" id="multiSubSeq" placeholder="如: ATGC...">
                <div class="limit-hint">限制: 最多替换 6 个连续碱基</div>
                <small id="multiSubError" class="error-msg hidden">错误：长度超过 6bp 限制</small>
            </div>

            <div id="aminoInput" class="form-group input-area hidden" style="margin-top:10px;">
                <label>目标氨基酸</label>
                <div class="row">
                    <select id="targetAmino">
                        <option value="A">Alanine (A)</option>
                        <option value="R">Arginine (R)</option>
                        <option value="N">Asparagine (N)</option>
                        <option value="D">Aspartic Acid (D)</option>
                        <option value="C">Cysteine (C)</option>
                        <option value="Q">Glutamine (Q)</option>
                        <option value="E">Glutamic Acid (E)</option>
                        <option value="G">Glycine (G)</option>
                        <option value="H">Histidine (H)</option>
                        <option value="I">Isoleucine (I)</option>
                        <option value="L">Leucine (L)</option>
                        <option value="K">Lysine (K)</option>
                        <option value="M">Methionine (M)</option>
                        <option value="F">Phenylalanine (F)</option>
                        <option value="P">Proline (P)</option>
                        <option value="S">Serine (S)</option>
                        <option value="T">Threonine (T)</option>
                        <option value="W">Tryptophan (W)</option>
                        <option value="Y">Tyrosine (Y)</option>
                        <option value="V">Valine (V)</option>
                        <option value="*">STOP (*)</option>
                    </select>
                    <select id="codonPreference" style="flex:1">
                        <option value="auto">自动最优密码子</option>
                    </select>
                </div>
            </div>

            <div id="insInput" class="form-group input-area hidden" style="margin-top:10px;">
                <label>插入序列 (5' -> 3')</label>
                <input type="text" id="insertSeq" placeholder="ATCG...">
                <div class="limit-hint">限制: 最多插入 10 bp</div>
                <small id="insError" class="error-msg hidden">错误：长度超过 10bp 限制</small>
            </div>
            
            <div id="delInput" class="form-group input-area hidden" style="margin-top:10px;">
                <label>删除长度 (bp)</label>
                <input type="number" id="delLengthInput" value="3" min="1">
                <div class="limit-hint" id="delLimitHint">限制: 不超过载体 70%</div>
                <small id="delError" class="error-msg hidden">错误：删除长度超过载体 70%</small>
            </div>
        </div>
        
        <button class="btn" id="generateBtn">生成引物与图谱</button>
        <button class="btn btn-outline" id="exportBtn">导出 CSV 报告</button>
    </div>

    <div class="panel">
        <div class="canvas-container">
            <canvas id="plasmidCanvas" width="380" height="380"></canvas>
            <div id="canvasTooltip" class="canvas-tooltip"></div>
            
            <div style="position: absolute; bottom: 10px; width: 100%; text-align: center;">
                 <div class="legend">
                    <div class="legend-item"><div class="dot" style="background:var(--danger)"></div>Mutation</div>
                    <div class="legend-item"><div class="dot" style="background:var(--primary)"></div>Primer Ext</div>
                    <div class="legend-item"><div class="dot" style="background:#d97706"></div>Primer Overlap</div>
                </div>
            </div>
        </div>

        <div>
            <h2 style="display:flex; justify-content:space-between; align-items:center;">
                引物设计结果
            </h2>
            <div id="primerResults">
                <div style="text-align: center; color: #94a3b8; padding: 2rem; background: #f8fafc; border-radius: 8px; border: 1px dashed #cbd5e1;">
                    请配置序列和参数后点击“生成”
                </div>
            </div>
        </div>
    </div>
</main>

<script>
/**
 * Scientific Data & Utils
 */
const NN_PARAMS = {
    'AA': [-7.9, -22.2], 'TT': [-7.9, -22.2], 'AT': [-7.2, -20.4], 'TA': [-7.2, -21.3],
    'CA': [-8.5, -22.7], 'TG': [-8.5, -22.7], 'GT': [-8.4, -22.4], 'AC': [-8.4, -22.4],
    'CT': [-7.8, -21.0], 'AG': [-7.8, -21.0], 'GA': [-8.2, -22.2], 'TC': [-8.2, -22.2],
    'CG': [-10.6, -27.2], 'GC': [-9.8, -24.4], 'GG': [-8.0, -19.9], 'CC': [-8.0, -19.9],
    'init': [0.2, -5.7], 'termGC': [0.1, -2.8], 'termAT': [2.3, 4.1]
};

const OPTIMAL_CODONS = {
    'A': 'GCG', 'R': 'CGT', 'N': 'AAC', 'D': 'GAT', 'C': 'TGC', 'Q': 'CAG', 'E': 'GAA', 'G': 'GGC',
    'H': 'CAT', 'I': 'ATT', 'L': 'CTG', 'K': 'AAA', 'M': 'ATG', 'F': 'TTC', 'P': 'CCG', 'S': 'AGC',
    'T': 'ACC', 'W': 'TGG', 'Y': 'TAT', 'V': 'GTG', '*': 'TAA'
};

const AA_MAP_REV = {
    'TTT':'F', 'TTC':'F', 'TTA':'L', 'TTG':'L', 'TCT':'S', 'TCC':'S', 'TCA':'S', 'TCG':'S',
    'TAT':'Y', 'TAC':'Y', 'TAA':'*', 'TAG':'*', 'TGT':'C', 'TGC':'C', 'TGA':'*', 'TGG':'W',
    'CTT':'L', 'CTC':'L', 'CTA':'L', 'CTG':'L', 'CCT':'P', 'CCC':'P', 'CCA':'P', 'CCG':'P',
    'CAT':'H', 'CAC':'H', 'CAA':'Q', 'CAG':'Q', 'CGT':'R', 'CGC':'R', 'CGA':'R', 'CGG':'R',
    'ATT':'I', 'ATC':'I', 'ATA':'I', 'ATG':'M', 'ACT':'T', 'ACC':'T', 'ACA':'T', 'ACG':'T',
    'AAT':'N', 'AAC':'N', 'AAA':'K', 'AAG':'K', 'AGT':'S', 'AGC':'S', 'AGA':'R', 'AGG':'R',
    'GTT':'V', 'GTC':'V', 'GTA':'V', 'GTG':'V', 'GCT':'A', 'GCC':'A', 'GCA':'A', 'GCG':'A',
    'GAT':'D', 'GAC':'D', 'GAA':'E', 'GAG':'E', 'GGT':'G', 'GGC':'G', 'GGA':'G', 'GGG':'G'
};

function revComp(seq) {
    const map = {'A':'T', 'T':'A', 'C':'G', 'G':'C', 'N':'N', 'a':'t', 't':'a', 'c':'g', 'g':'c'};
    return seq.split('').reverse().map(b => map[b] || b).join('');
}

function getCircularSeq(fullSeq, start, length) {
    const len = fullSeq.length;
    let s = (start % len + len) % len; 
    let result = "";
    for (let i = 0; i < length; i++) {
        result += fullSeq[(s + i) % len];
    }
    return result;
}

function calculateTm(seq, conc_primer_nM = 250) {
    seq = seq.toUpperCase();
    if (seq.length < 8) return 0;
    
    let dH = NN_PARAMS.init[0];
    let dS = NN_PARAMS.init[1];

    if (/[AT]/.test(seq[0])) { dH += NN_PARAMS.termAT[0]; dS += NN_PARAMS.termAT[1]; } 
    else { dH += NN_PARAMS.termGC[0]; dS += NN_PARAMS.termGC[1]; }

    if (/[AT]/.test(seq[seq.length-1])) { dH += NN_PARAMS.termAT[0]; dS += NN_PARAMS.termAT[1]; } 
    else { dH += NN_PARAMS.termGC[0]; dS += NN_PARAMS.termGC[1]; }

    for (let i = 0; i < seq.length - 1; i++) {
        let neighbor = seq.substring(i, i+2);
        if (NN_PARAMS[neighbor]) { dH += NN_PARAMS[neighbor][0]; dS += NN_PARAMS[neighbor][1]; }
    }

    const R = 1.987;
    const C = conc_primer_nM * 1e-9;
    const Na = 50e-3;
    const Mg = 2.0e-3;
    const Na_eq = Na + 3.3 * Math.sqrt(Mg); 
    const salt_corr = 16.6 * Math.log10(Na_eq);

    return parseFloat(((dH * 1000) / (dS + R * Math.log(C/4)) - 273.15 + salt_corr).toFixed(1));
}

/**
 * DOM Elements
 */
const els = {
    plasmidSeq: document.getElementById('plasmidSeq'),
    seqLength: document.getElementById('seqLength'),
    autoTm: document.getElementById('autoTm'),
    fwdExtLen: document.getElementById('fwdExtLen'),
    revExtLen: document.getElementById('revExtLen'),
    ovLen: document.getElementById('ovLen'),
    mutType: document.getElementById('mutationType'),
    posSlider: document.getElementById('posSlider'),
    posInput: document.getElementById('posInput'),
    contextSeq: document.getElementById('contextSeq'),
    targetBase: document.getElementById('targetBase'),
    multiSubSeq: document.getElementById('multiSubSeq'),
    multiSubError: document.getElementById('multiSubError'),
    insertSeq: document.getElementById('insertSeq'),
    insError: document.getElementById('insError'),
    delLengthInput: document.getElementById('delLengthInput'),
    delLimitHint: document.getElementById('delLimitHint'),
    delError: document.getElementById('delError'),
    generateBtn: document.getElementById('generateBtn'),
    canvas: document.getElementById('plasmidCanvas'),
    results: document.getElementById('primerResults'),
    exportBtn: document.getElementById('exportBtn'),
    targetAmino: document.getElementById('targetAmino')
};

let appData = { seq: "", primers: null };

/**
 * Event Listeners
 */
els.plasmidSeq.addEventListener('input', (e) => {
    let val = e.target.value.replace(/[^ATCGatcg]/g, '').toUpperCase();
    e.target.value = val;
    els.seqLength.textContent = val.length + " bp";
    els.posSlider.max = val.length || 1;
    validateAll(); // Re-validate deletion limit on seq change
    updateContext();
});

[els.posSlider, els.posInput].forEach(el => el.addEventListener('input', (e) => {
    if(e.target === els.posSlider) els.posInput.value = els.posSlider.value;
    else els.posSlider.value = els.posInput.value;
    updateContext();
}));

// Mutation Type Toggle
els.mutType.addEventListener('change', () => {
    const type = els.mutType.value;
    document.querySelectorAll('.input-area').forEach(el => el.classList.add('hidden'));
    
    if (type === 'substitution') document.getElementById('baseSubInput').classList.remove('hidden');
    else if (type === 'multi_substitution') document.getElementById('multiSubInput').classList.remove('hidden');
    else if (type === 'amino') document.getElementById('aminoInput').classList.remove('hidden');
    else if (type === 'insertion') document.getElementById('insInput').classList.remove('hidden');
    else if (type === 'deletion') document.getElementById('delInput').classList.remove('hidden');
    validateAll(); // Re-validate when type changes
    updateContext();
});

// Validation Function
function validateAll() {
    const type = els.mutType.value;
    let isValid = true;
    const seqLen = els.plasmidSeq.value.length;

    // Reset all errors
    els.multiSubError.classList.add('hidden');
    els.multiSubSeq.classList.remove('invalid');
    els.insError.classList.add('hidden');
    els.insertSeq.classList.remove('invalid');
    els.delError.classList.add('hidden');
    els.delLengthInput.classList.remove('invalid');
    els.delLimitHint.textContent = `限制: 不超过载体 70% (${Math.floor(seqLen * 0.7)} bp)`;

    if (type === 'multi_substitution') {
        let val = els.multiSubSeq.value;
        if (val.length > 6) {
            els.multiSubError.classList.remove('hidden');
            els.multiSubSeq.classList.add('invalid');
            isValid = false;
        }
    } else if (type === 'insertion') {
        let val = els.insertSeq.value;
        if (val.length > 10) {
            els.insError.classList.remove('hidden');
            els.insertSeq.classList.add('invalid');
            isValid = false;
        }
    } else if (type === 'deletion') {
        let val = parseInt(els.delLengthInput.value);
        if (seqLen > 0 && val > seqLen * 0.7) {
            els.delError.classList.remove('hidden');
            els.delLengthInput.classList.add('invalid');
            isValid = false;
        }
    }

    els.generateBtn.disabled = !isValid;
}

// Bind Validation to Inputs
els.multiSubSeq.addEventListener('input', (e) => {
    e.target.value = e.target.value.replace(/[^ATCGatcg]/g, '').toUpperCase();
    validateAll();
});
els.insertSeq.addEventListener('input', (e) => {
    e.target.value = e.target.value.replace(/[^ATCGatcg]/g, '').toUpperCase();
    validateAll();
});
els.delLengthInput.addEventListener('input', validateAll);


els.generateBtn.addEventListener('click', designPrimers);
[els.fwdExtLen, els.revExtLen].forEach(el => {
    el.addEventListener('change', () => {
        let v = parseInt(el.value);
        if(v < 10) el.value = 10;
        if(v > 20) el.value = 20;
    });
});


/**
 * Core Logic
 */
function updateContext() {
    const seq = els.plasmidSeq.value;
    if (!seq) return;
    const idx = parseInt(els.posInput.value) - 1;
    const before = getCircularSeq(seq, idx - 5, 5).toLowerCase();
    const target = getCircularSeq(seq, idx, 1);
    const after = getCircularSeq(seq, idx + 1, 5).toLowerCase();
    
    let html = `${before} <span style="color:var(--danger); font-weight:bold; border-bottom:2px solid var(--danger)">${target}</span> ${after}`;
    if (els.mutType.value === 'amino') {
        const codon = getCircularSeq(seq, idx, 3);
        const aa = AA_MAP_REV[codon] || '?';
        html += `<br><span style="color:var(--primary); font-size:11px;">Codon: ${codon} (${aa})</span>`;
    }
    els.contextSeq.innerHTML = html;
}

function optimizeExtensionLength(fullSeq, startIdx, isRev) {
    let bestLen = 15;
    let minDiff = 999;
    const targetTm = 35.0;

    for (let len = 10; len <= 20; len++) {
        let seqFrag = "";
        if (!isRev) {
            seqFrag = getCircularSeq(fullSeq, startIdx, len);
        } else {
            let fragRaw = getCircularSeq(fullSeq, startIdx - len, len);
            seqFrag = revComp(fragRaw);
        }
        
        const tm = calculateTm(seqFrag);
        const diff = Math.abs(tm - targetTm);
        
        if (diff < minDiff) {
            minDiff = diff;
            bestLen = len;
        }
    }
    return bestLen;
}

function designPrimers() {
    const seq = els.plasmidSeq.value;
    const pos = parseInt(els.posInput.value) - 1; 
    let ovLen = parseInt(els.ovLen.value);
    const type = els.mutType.value;
    
    if (!seq) return alert("请输入序列");

    // Mutation Definition & Validation
    let mutInfo = { type: type, seq: "", delLen: 0, desc: "" };
    
    if (type === 'substitution') {
        mutInfo.seq = els.targetBase.value.toUpperCase();
        mutInfo.delLen = 1;
        mutInfo.desc = `${getCircularSeq(seq, pos, 1)} > ${mutInfo.seq}`;
    } 
    else if (type === 'multi_substitution') {
        const s = els.multiSubSeq.value.toUpperCase();
        mutInfo.seq = s;
        mutInfo.delLen = s.length; 
        mutInfo.desc = `Replace ${s.length}bp > ${s}`;
    }
    else if (type === 'amino') {
        mutInfo.seq = OPTIMAL_CODONS[els.targetAmino.value];
        mutInfo.delLen = 3;
        mutInfo.desc = `${AA_MAP_REV[getCircularSeq(seq, pos, 3)]}->${els.targetAmino.value}`;
    } 
    else if (type === 'insertion') {
        const s = els.insertSeq.value.toUpperCase();
        mutInfo.seq = s;
        mutInfo.delLen = 0;
        mutInfo.desc = `Insert ${mutInfo.seq.length}bp`;
    } 
    else if (type === 'deletion') {
        const delLen = parseInt(els.delLengthInput.value);
        mutInfo.seq = "";
        mutInfo.delLen = delLen;
        mutInfo.desc = `Delete ${mutInfo.delLen}bp`;
    }

    // Auto Optimize Extension
    if (els.autoTm.checked) {
        const fwdStart = pos + mutInfo.delLen;
        const bestFwdLen = optimizeExtensionLength(seq, fwdStart, false);
        els.fwdExtLen.value = bestFwdLen;

        const revRefPoint = pos - ovLen;
        const bestRevLen = optimizeExtensionLength(seq, revRefPoint, true);
        els.revExtLen.value = bestRevLen;
    }

    const fwdExtLen = parseInt(els.fwdExtLen.value);
    const revExtLen = parseInt(els.revExtLen.value);

    // Build Sequences (Partial Overlap)
    // Fwd: [Overlap] + [Mut] + [Ext]
    const fwdOverlap = getCircularSeq(seq, pos - ovLen, ovLen);
    const fwdMut = mutInfo.seq;
    const fwdExt = getCircularSeq(seq, pos + mutInfo.delLen, fwdExtLen);
    const fwdFull = fwdOverlap + fwdMut.toLowerCase() + fwdExt;

    // Rev: [Overlap RC] + [Mut RC] + [Ext RC]
    const revOverlap = revComp(fwdOverlap); 
    const revMut = revComp(fwdMut);
    const revExtRaw = getCircularSeq(seq, pos - ovLen - revExtLen, revExtLen);
    const revExt = revComp(revExtRaw);
    const revFull = revOverlap + revMut.toLowerCase() + revExt;

    appData.primers = {
        fwd: { seq: fwdFull, ov: fwdOverlap, mut: fwdMut, ext: fwdExt, tmExt: calculateTm(fwdExt) },
        rev: { seq: revFull, ov: revOverlap, mut: revMut, ext: revExt, tmExt: calculateTm(revExt) },
        info: mutInfo,
        pos: pos,
        params: { fwdExt: fwdExtLen, revExt: revExtLen, ov: ovLen }
    };

    renderResults();
    drawPlasmid();
}

function renderResults() {
    const p = appData.primers;
    if(!p) return;

    const mkResult = (label, data) => `
        <div class="result-card" style="margin-bottom:12px;">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3 style="margin:0; color:var(--text);">${label} Primer</h3>
                <span style="font-size:11px; color:#666;">${data.seq.length}nt | Tm(Ext): <b>${data.tmExt}°C</b></span>
            </div>
            <div class="primer-box">
                <span class="seq-label">5' [Overlap] [Mut] [Extension] 3'</span>
                <div class="primer-seq">
                    <span class="part-overlap">${data.ov}</span><span class="part-mut">${data.mut.toLowerCase()}</span><span class="part-ext">${data.ext}</span>
                </div>
            </div>
        </div>`;

    els.results.innerHTML = mkResult('Forward', p.fwd) + mkResult('Reverse', p.rev);
}

function drawPlasmid() {
    const ctx = els.canvas.getContext('2d');
    const w = els.canvas.width, h = els.canvas.height;
    const cx = w/2, cy = h/2, r = 130;
    
    ctx.clearRect(0,0,w,h);
    
    // 1. Draw Thicker Backbone
    ctx.beginPath();
    ctx.arc(cx, cy, r, 0, 2*Math.PI);
    ctx.strokeStyle = '#e2e8f0';
    ctx.lineWidth = 20;
    ctx.stroke();

    const totalLen = els.plasmidSeq.value.length || 0;

    // Center Text (Vector Length)
    ctx.fillStyle = '#64748b';
    ctx.font = 'bold 14px sans-serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText("GeneDIY-C", cx, cy - 10);
    ctx.font = '12px monospace';
    ctx.fillText(`${totalLen} bp`, cx, cy + 10);

    if(!appData.primers || totalLen === 0) return;

    // Calc Angles
    // Use visual scale to ensure visibility even for small primers
    const visualScale = 0.02; // Arbitrary visual factor per bp
    const posRad = -0.5*Math.PI + (appData.primers.pos / totalLen) * 2*Math.PI;
    
    // Params
    const ovRad = appData.primers.params.ov * visualScale;
    const fwdExtRad = appData.primers.params.fwdExt * visualScale;
    const revExtRad = appData.primers.params.revExt * visualScale;

    // 2. Mutation Mark (Red Wedge)
    ctx.beginPath();
    ctx.arc(cx, cy, r, posRad - 0.02, posRad + 0.02);
    ctx.strokeStyle = '#e11d48';
    ctx.lineWidth = 22; // Slightly thicker than backbone to stand out
    ctx.stroke();

    // 3. Draw Fwd Primer (Outer Ring)
    // Structure: Tail (Overlap) -> Head (Extension)
    // Overlap: Starts at `pos - ov`, ends at `pos`
    // Ext: Starts at `pos`, ends at `pos + ext`
    const rOuter = r + 25;
    
    // Fwd Overlap (Tail) - Orange
    drawArcSolid(ctx, cx, cy, rOuter, posRad - ovRad, posRad, '#d97706');
    // Fwd Extension (Head) - Blue with Arrow
    drawArcArrow(ctx, cx, cy, rOuter, posRad, posRad + fwdExtRad, '#4f46e5', true);

    // 4. Draw Rev Primer (Inner Ring)
    // Structure: Tail (Overlap) -> Head (Extension)
    // Overlap: Starts at `pos`, ends at `pos - ov` (CCW)
    // Ext: Starts at `pos - ov`, ends at `pos - ov - ext` (CCW)
    const rInner = r - 25;

    // Rev Overlap (Tail) - Orange
    drawArcSolid(ctx, cx, cy, rInner, posRad - ovRad, posRad, '#d97706');
    // Rev Extension (Head) - Blue with Arrow
    drawArcArrow(ctx, cx, cy, rInner, posRad - ovRad, posRad - ovRad - revExtRad, '#4f46e5', false);
}

function drawArcArrow(ctx, cx, cy, r, startAngle, endAngle, color, cw) {
    ctx.beginPath();
    ctx.arc(cx, cy, r, startAngle, endAngle, !cw);
    ctx.strokeStyle = color;
    ctx.lineWidth = 6;
    ctx.stroke();
    
    // Arrowhead
    const tipX = cx + r * Math.cos(endAngle);
    const tipY = cy + r * Math.sin(endAngle);
    ctx.save();
    ctx.translate(tipX, tipY);
    ctx.rotate(endAngle + (cw ? Math.PI/2 : -Math.PI/2));
    ctx.beginPath(); 
    ctx.moveTo(0,0); ctx.lineTo(-5,10); ctx.lineTo(5,10); 
    ctx.fillStyle = color;
    ctx.fill();
    ctx.restore();
}

function drawArcSolid(ctx, cx, cy, r, startAngle, endAngle, color) {
    ctx.beginPath();
    ctx.arc(cx, cy, r, startAngle, endAngle, false); 
    ctx.strokeStyle = color;
    ctx.lineWidth = 6;
    ctx.stroke();
}

// Export CSV
els.exportBtn.addEventListener('click', () => {
    if (!appData.primers) return alert("请先生成引物数据");
    
    const p = appData.primers;
    // BOM for Excel
    const BOM = "\uFEFF";
    const content = `GeneDIY-C Primer Report
Target,${p.info.desc}
Strategy,Partial Overlap (V1.4)
Vector Length,${els.plasmidSeq.value.length} bp
Overlap Len,${p.params.ov} bp
Fwd Extension,${p.params.fwdExt} bp (Tm ${p.fwd.tmExt}C)
Rev Extension,${p.params.revExt} bp (Tm ${p.rev.tmExt}C)

Primer Name,Sequence (5'-3'),Length,Tm (Ext),Type
Forward,${p.fwd.seq},${p.fwd.seq.length},${p.fwd.tmExt},Overlap+Mut+Ext
Reverse,${p.rev.seq},${p.rev.seq.length},${p.rev.tmExt},Overlap+Mut+Ext
`;
    
    const blob = new Blob([BOM + content], {type: 'text/csv;charset=utf-8;'});
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `GeneDIY-C_primers_${new Date().toISOString().slice(0,10)}.csv`;
    link.click();
});

// Init
drawPlasmid();
</script>
</body>
</html>